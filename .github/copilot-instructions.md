# Autonome Copilot Instructions
- **Project Overview**: Next.js 16 app-router dashboard that tracks AI-driven crypto trades; scheduling logic and trading services live in server-only modules under `src/lib`, while client UI lives in `src/components` and consumes JSON APIs in `src/app/api`.
- **Running Locally**: `bun run dev` starts TurboPack on port 3001; the schedulers already spin up via the server import in `src/app/layout.tsx`.
- **Production Start**: Use `bun run start-with-schedulers.ts` to launch Next after booting the schedulers so background intervals stay alive outside dev.
- **Environment Flags**: `TRADING_MODE=live|simulated` toggles between real exchange calls and the in-repo simulator; `DATABASE_URL`, `OPENROUTER_API_KEY`, `NIM_API_KEY`, `LIGHTER_BASE_URL`, and `LIGHTER_API_KEY_INDEX` are required for full functionality; the `SIM_*` envs override simulator behaviour.
- **Prisma Data Model**: Tables (`prisma/schema.prisma`) capture models, invocations, tool calls, and portfolio snapshots; every trade workflow must write `Invocations`, append `ToolCalls` metadata JSON, and upsert into `PortfolioSize` to keep the UI plots accurate.
- **Scheduled Workflow**: `src/lib/tradeSchedulerBootstrap.ts` runs on the server and calls `ensureTradeScheduler` (5-min loop) plus `ensurePortfolioScheduler` (5-min loop) so do not import these modules client-side; both rely on `globalThis` handles to avoid duplicate timers.
- **Trade Execution Path**: `src/lib/tradeExecutor.ts` pulls accounts from Prisma, fetches portfolio + open positions, enriches the `PROMPT`, and calls OpenRouter with two tool callbacks (`createPosition`, `closePosition`); remember to update both live and simulator branches if you change tool signatures.
- **Order Placement**: Live trading uses the custom Lighter signer in `lighter-sdk-ts/signer.ts` with market metadata from `src/lib/markets.ts`; simulator mode funnels through `ExchangeSimulator.placeOrder` which simulates fills, slippage, and fees.
- **Portfolio Data**: `src/lib/priceTracker.ts` periodically persists `portfolio.total` strings; keep them numeric-as-string because the front-end parser in `PerformanceGraph` (`src/components/performance-graph.tsx`) expects precise decimals.
- **Indicator Inputs**: `src/lib/stockData.ts` pulls candles via `lighter-sdk` and computes EMA/MACD in `src/lib/indicators.ts`; expand indicators here, and surface them by filling the `{{ALL_INDICATOR_DATA}}` placeholder in `src/lib/prompt.ts`.
- **Simulator Stack**: Setting `TRADING_MODE=simulated` activates `/api/sim/*` routes backed by `src/lib/simulator`; the `/simulator` page streams events over WebSocket (`useSimStream.tsx`), so maintain event shapes defined in `src/lib/simulator/types.ts`.
- **API Contracts**: UI polling endpoints live under `src/app/api/{trades,positions,invocations,portfolio-history}`; ensure response shapes remain stable (e.g., `positions` includes `totalUnrealizedPnl` and `availableCash`) or adjust `TradesSidebar` accordingly.
- **Chat & AI**: `/ai` uses `DefaultChatTransport` and should align with the server handler in `src/app/api/chat/route.ts`; if you rename the endpoint remember to update both sides plus any `useChat` hooks.
- **Config Conventions**: Keep runtime-only imports (Prisma, schedulers, simulator) out of client components; colocate new trading helpers under `src/lib` and expose them through API routes rather than importing server code into React.
- **Generated Code**: Everything under `lighter-sdk-ts/generated` and `generated/prisma` is auto-produced—do not edit manually; regenerate via the upstream SDK or Prisma CLI when schemas change.
- **Adding Markets**: Extend `src/lib/markets.ts`, update simulator metadata (`ExchangeSimulator` pulls from that map), and adjust UI badges/listings to surface the new symbol.
- **Testing Hooks**: Manual helpers like `runManualCreatePosition()` in `tradeExecutor.ts` exist for ad-hoc debugging—wrap new diagnostic flows similarly and guard them behind `if ((import.meta as { main?: boolean }).main)` to keep production imports clean.
- **Data Refresh Rates**: Client polling intervals (e.g., 10s in `TradesSidebar`, 3 min in `PerformanceGraph`) assume the 5-min scheduler cadence; if you change scheduler intervals, revisit these timers to avoid stale dashboards.
- **Error Logging**: Server modules log to stdout; keep them concise because they surface in deployment logs used for monitoring trade failures.
- **Before Shipping**: Run `bun prisma migrate deploy` (or `prisma db push` for dev) after schema tweaks and verify both live + simulated modes by hitting `/api/init-schedulers` once to confirm timers register.
- **Bun no npm**: Use `bun run <script>` instead of `npm run <script>` for all commands.
