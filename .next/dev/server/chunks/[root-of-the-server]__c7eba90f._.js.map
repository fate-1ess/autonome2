{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/fateless/Documents/Projects/autonome2/src/app/api/trades/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\ntype CreatePositionRecord = {\r\n  createdAt: Date;\r\n  symbol: string;\r\n  modelId: string;\r\n  side?: string;\r\n  quantity: number | null;\r\n};\r\n\r\ntype CompletedTrade = {\r\n  id: string;\r\n  modelId: string;\r\n  modelName: string;\r\n  modelRouterName: string;\r\n  symbol: string;\r\n  side: string;\r\n  quantity: number | null;\r\n  entryPrice: number | null;\r\n  exitPrice: number | null;\r\n  entryNotional: number | null;\r\n  exitNotional: number | null;\r\n  netPnl: number | null;\r\n  openedAt: string | null;\r\n  closedAt: string;\r\n  holdingTime: string | null;\r\n  timestamp: string;\r\n};\r\n\r\nconst canonicalSymbol = (symbol: string | undefined | null) => {\r\n  if (!symbol) return \"\";\r\n  return symbol.toUpperCase().replace(/[^A-Z0-9]/g, \"\").replace(/USDT$/, \"\");\r\n};\r\n\r\nconst toNumber = (value: unknown): number | null => {\r\n  if (value == null) return null;\r\n  if (typeof value === \"number\") return Number.isFinite(value) ? value : null;\r\n  if (typeof value === \"string\" && value.length > 0) {\r\n    const parsed = Number.parseFloat(value);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n  }\r\n  return null;\r\n};\r\n\r\nconst formatDuration = (openedAt: Date, closedAt: Date) => {\r\n  const diffMs = closedAt.getTime() - openedAt.getTime();\r\n  if (diffMs <= 0) return \"<1M\";\r\n  const totalMinutes = Math.floor(diffMs / 60000);\r\n  const days = Math.floor(totalMinutes / (60 * 24));\r\n  const hours = Math.floor((totalMinutes % (60 * 24)) / 60);\r\n  const minutes = totalMinutes % 60;\r\n\r\n  const parts: string[] = [];\r\n  if (days > 0) parts.push(`${days}D`);\r\n  if (hours > 0) parts.push(`${hours}H`);\r\n  parts.push(`${minutes}M`);\r\n  return parts.join(\" \");\r\n};\r\n\r\nconst formatTimestamp = (date: Date) => {\r\n  return date.toLocaleString(\"en-US\", {\r\n    month: \"2-digit\",\r\n    day: \"2-digit\",\r\n    hour: \"2-digit\",\r\n    minute: \"2-digit\",\r\n    hour12: true,\r\n  });\r\n};\r\n\r\nconst consumeLatestCreateRecord = (\r\n  lookup: Map<string, CreatePositionRecord[]>,\r\n  modelId: string,\r\n  symbol: string,\r\n  closedAt: Date,\r\n) => {\r\n  const key = `${modelId}|${symbol}`;\r\n  const records = lookup.get(key);\r\n  if (!records || records.length === 0) return null;\r\n\r\n  for (let i = records.length - 1; i >= 0; i -= 1) {\r\n    if (records[i].createdAt <= closedAt) {\r\n      const [record] = records.splice(i, 1);\r\n      return record;\r\n    }\r\n  }\r\n  return null;\r\n};\r\n\r\nexport async function GET() {\r\n  try {\r\n    const closeCalls = await prisma.toolCalls.findMany({\r\n      where: { toolCallType: \"CLOSE_POSITION\" },\r\n      include: {\r\n        invocation: {\r\n          include: {\r\n            model: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: \"desc\" },\r\n      take: 400,\r\n    });\r\n\r\n    if (closeCalls.length === 0) {\r\n      return NextResponse.json({ trades: [] });\r\n    }\r\n\r\n    const modelIds = Array.from(\r\n      new Set(closeCalls.map((call) => call.invocation.modelId)),\r\n    );\r\n\r\n    const createCalls = await prisma.toolCalls.findMany({\r\n      where: {\r\n        toolCallType: \"CREATE_POSITION\",\r\n        invocation: {\r\n          modelId: { in: modelIds },\r\n        },\r\n      },\r\n      include: {\r\n        invocation: {\r\n          select: {\r\n            modelId: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: \"asc\" },\r\n    });\r\n\r\n    const createLookup = new Map<string, CreatePositionRecord[]>();\r\n\r\n    for (const call of createCalls) {\r\n      let metadata: any;\r\n      try {\r\n        metadata = JSON.parse(call.metadata ?? \"{}\");\r\n      } catch {\r\n        metadata = {};\r\n      }\r\n      const positions = Array.isArray(metadata.positions) ? metadata.positions : [];\r\n\r\n      for (const position of positions) {\r\n        const symbol = canonicalSymbol(position.symbol);\r\n        if (!symbol) continue;\r\n        const record: CreatePositionRecord = {\r\n          createdAt: call.createdAt,\r\n          symbol,\r\n          modelId: call.invocation.modelId,\r\n          side: typeof position.side === \"string\" ? position.side : undefined,\r\n          quantity: toNumber(position.quantity),\r\n        };\r\n\r\n        const key = `${record.modelId}|${record.symbol}`;\r\n        const existing = createLookup.get(key) ?? [];\r\n        existing.push(record);\r\n        createLookup.set(key, existing);\r\n      }\r\n    }\r\n\r\n    const trades = closeCalls.flatMap((call) => {\r\n      let metadata: any;\r\n      try {\r\n        metadata = JSON.parse(call.metadata ?? \"{}\");\r\n      } catch {\r\n        metadata = {};\r\n      }\r\n\r\n      const closedPositions = Array.isArray(metadata.closedPositions)\r\n        ? metadata.closedPositions\r\n        : [];\r\n\r\n      if (closedPositions.length === 0) {\r\n        return [];\r\n      }\r\n\r\n      const closedAt = call.createdAt;\r\n      const model = call.invocation.model;\r\n      const modelId = call.invocation.modelId;\r\n      const closingTrades: CompletedTrade[] = [];\r\n\r\n      closedPositions.forEach((position: any, idx: number) => {\r\n        const symbol = canonicalSymbol(position.symbol ?? metadata.symbols?.[idx]);\r\n        if (!symbol) {\r\n          return;\r\n        }\r\n\r\n        const createRecord = consumeLatestCreateRecord(createLookup, modelId, symbol, closedAt);\r\n        const entryPrice = toNumber(position.entryPrice ?? position.markPrice);\r\n        const exitPrice = toNumber(position.exitPrice ?? position.markPrice);\r\n        const quantity = toNumber(position.quantity ?? createRecord?.quantity);\r\n        const entryNotional = position.entryNotional != null\r\n          ? toNumber(position.entryNotional)\r\n          : entryPrice != null && quantity != null\r\n            ? entryPrice * quantity\r\n            : null;\r\n        const exitNotional = position.exitNotional != null\r\n          ? toNumber(position.exitNotional)\r\n          : exitPrice != null && quantity != null\r\n            ? exitPrice * quantity\r\n            : null;\r\n        const pnl = toNumber(position.netPnl ?? position.realizedPnl ?? position.unrealizedPnl);\r\n        const openedAt = createRecord?.createdAt ?? null;\r\n        const holdingTime = openedAt ? formatDuration(openedAt, closedAt) : null;\r\n\r\n        closingTrades.push({\r\n          id: `${call.id}:${symbol}:${idx}`,\r\n          modelId,\r\n          modelName: model.name,\r\n          modelRouterName: model.openRoutermodelName,\r\n          symbol,\r\n          side: typeof position.side === \"string\"\r\n            ? position.side.toUpperCase()\r\n            : createRecord?.side?.toUpperCase() ?? \"LONG\",\r\n          quantity,\r\n          entryPrice,\r\n          exitPrice,\r\n          entryNotional,\r\n          exitNotional,\r\n          netPnl: pnl,\r\n          openedAt: openedAt ? openedAt.toISOString() : null,\r\n          closedAt: closedAt.toISOString(),\r\n          holdingTime,\r\n          timestamp: formatTimestamp(closedAt),\r\n        });\r\n      });\r\n\r\n      return closingTrades;\r\n    });\r\n\r\n    return NextResponse.json({ trades });\r\n  } catch (error) {\r\n    console.error(\"Error fetching trades:\", error);\r\n    return NextResponse.json({ error: \"Failed to fetch trades\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}